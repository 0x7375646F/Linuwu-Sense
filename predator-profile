#!/bin/bash
#
# Predator Profile Control Script
# Controls GPU power limit via Predator Sense power profiles
#
# Usage: predator-profile {quiet|balanced|performance|turbo|status|fan-auto|fan-max|fan-custom}
#
# Power Profiles:
#   quiet       - 60W GPU power limit (power saving)
#   balanced    - 80W GPU power limit (balanced performance)
#   performance - 100W GPU power limit (high performance)
#   turbo       - 125W GPU power limit (maximum performance)
#   status      - Show current profile
#
# Fan Control:
#   fan-auto    - Set fans to automatic mode
#   fan-max     - Set fans to maximum speed
#   fan-custom  - Set custom fan speeds (CPU,GPU)

SYSFS_PATH="/sys/devices/platform/acer-wmi/predator_sense/power_profile"
FAN_PATH="/sys/devices/platform/acer-wmi/predator_sense/fan_speed"
BATTERY_PATH="/sys/devices/platform/acer-wmi/predator_sense/battery_limiter"

# Check if sysfs interface exists
if [ ! -f "$SYSFS_PATH" ]; then
    echo "Error: Predator Sense power profile interface not found!"
    echo "Make sure the linuwu_sense module is loaded."
    exit 1
fi

case "$1" in
    quiet)
        echo 0 | sudo tee $SYSFS_PATH > /dev/null
        if [ $? -eq 0 ]; then
            echo "Power profile set to QUIET (60W GPU limit)"
        else
            echo "Failed to set power profile"
            exit 1
        fi
        ;;
    balanced)
        echo 1 | sudo tee $SYSFS_PATH > /dev/null
        if [ $? -eq 0 ]; then
            echo "Power profile set to BALANCED (80W GPU limit)"
        else
            echo "Failed to set power profile"
            exit 1
        fi
        ;;
    performance)
        echo 2 | sudo tee $SYSFS_PATH > /dev/null
        if [ $? -eq 0 ]; then
            echo "Power profile set to PERFORMANCE (100W GPU limit)"
        else
            echo "Failed to set power profile"
            exit 1
        fi
        ;;
    turbo)
        echo 3 | sudo tee $SYSFS_PATH > /dev/null
        if [ $? -eq 0 ]; then
            echo "Power profile set to TURBO (125W GPU limit)"
        else
            echo "Failed to set power profile"
            exit 1
        fi
        ;;
    status)
        CURRENT=$(cat $SYSFS_PATH)
        case $CURRENT in
            0) echo "Current profile: QUIET (60W GPU limit)" ;;
            1) echo "Current profile: BALANCED (80W GPU limit)" ;;
            2) echo "Current profile: PERFORMANCE (100W GPU limit)" ;;
            3) echo "Current profile: TURBO (125W GPU limit)" ;;
            *) echo "Current profile: UNKNOWN ($CURRENT)" ;;
        esac
        
        # Show fan status
        if [ -f "$FAN_PATH" ]; then
            FAN_STATUS=$(cat $FAN_PATH)
            CPU_FAN=$(echo $FAN_STATUS | cut -d',' -f1)
            GPU_FAN=$(echo $FAN_STATUS | cut -d',' -f2)
            echo ""
            echo "Fan Settings: CPU=$CPU_FAN%, GPU=$GPU_FAN%"
            if [ "$CPU_FAN" = "0" ] && [ "$GPU_FAN" = "0" ]; then
                echo "Fan Mode: AUTO"
            elif [ "$CPU_FAN" = "100" ] && [ "$GPU_FAN" = "100" ]; then
                echo "Fan Mode: MAXIMUM"
            else
                echo "Fan Mode: CUSTOM"
            fi
        fi
        
        # Show battery limiter status
        if [ -f "$BATTERY_PATH" ]; then
            BAT_STATUS=$(cat $BATTERY_PATH)
            echo ""
            if [ "$BAT_STATUS" = "1" ]; then
                echo "Battery Limiter: ENABLED (80% limit)"
            else
                echo "Battery Limiter: DISABLED (100% charge)"
            fi
        fi
        
        # Try to show GPU power limit from nvidia-smi
        if command -v nvidia-smi &> /dev/null; then
            echo ""
            echo "NVIDIA GPU Power Status:"
            nvidia-smi -q -d POWER | grep -E "Power Limit|Power Draw" | head -4
        fi
        ;;
    fan-auto)
        if [ -f "$FAN_PATH" ]; then
            echo "0,0" | sudo tee $FAN_PATH > /dev/null
            echo "Fans set to AUTO mode (system controlled)"
        else
            echo "Fan control not available"
            exit 1
        fi
        ;;
    fan-max)
        if [ -f "$FAN_PATH" ]; then
            echo "100,100" | sudo tee $FAN_PATH > /dev/null
            echo "Fans set to MAXIMUM speed (100%)"
        else
            echo "Fan control not available"
            exit 1
        fi
        ;;
    fan-custom)
        if [ -f "$FAN_PATH" ]; then
            if [ $# -ne 3 ]; then
                echo "Usage: $0 fan-custom <cpu_speed> <gpu_speed>"
                echo "Example: $0 fan-custom 50 70"
                exit 1
            fi
            CPU=$2
            GPU=$3
            echo "$CPU,$GPU" | sudo tee $FAN_PATH > /dev/null
            echo "Fans set to: CPU=$CPU%, GPU=$GPU%"
        else
            echo "Fan control not available"
            exit 1
        fi
        ;;
    battery-enable)
        if [ -f "$BATTERY_PATH" ]; then
            echo 1 | sudo tee $BATTERY_PATH > /dev/null
            echo "Battery limiter ENABLED (80% charge limit)"
            echo "Recommended for extending battery lifespan"
        else
            echo "Battery limiter not available"
            exit 1
        fi
        ;;
    battery-disable)
        if [ -f "$BATTERY_PATH" ]; then
            echo 0 | sudo tee $BATTERY_PATH > /dev/null
            echo "Battery limiter DISABLED (100% charge)"
        else
            echo "Battery limiter not available"
            exit 1
        fi
        ;;
    kb-*)
        # Pass keyboard commands to predator-keyboard script
        KB_SCRIPT="/home/sbochna/Projects/Linuwu-Sense-PHN14-51/predator-keyboard"
        if [ ! -x "$KB_SCRIPT" ]; then
            KB_SCRIPT="$(dirname $0)/predator-keyboard"
        fi
        
        if [ ! -x "$KB_SCRIPT" ]; then
            echo "Keyboard control script not found"
            exit 1
        fi
        
        # Extract keyboard command (remove kb- prefix)
        KB_CMD="${1#kb-}"
        shift
        $KB_SCRIPT $KB_CMD "$@"
        ;;
    *)
        echo "Usage: $0 {quiet|balanced|performance|turbo|status|fan-auto|fan-max|fan-custom|battery-enable|battery-disable|kb-<command>}"
        echo ""
        echo "Power Profiles:"
        echo "  quiet           - 60W GPU power limit (power saving)"
        echo "  balanced        - 80W GPU power limit (balanced performance)"
        echo "  performance     - 100W GPU power limit (high performance)"
        echo "  turbo           - 125W GPU power limit (maximum performance)"
        echo "  status          - Show all current settings"
        echo ""
        echo "Fan Control:"
        echo "  fan-auto        - Set fans to automatic mode"
        echo "  fan-max         - Set fans to maximum speed"
        echo "  fan-custom      - Set custom fan speeds: fan-custom <cpu> <gpu>"
        echo ""
        echo "Battery Management:"
        echo "  battery-enable  - Enable 80% charge limit (extend battery life)"
        echo "  battery-disable - Disable limit (charge to 100%)"
        echo ""
        echo "Keyboard RGB Control:"
        echo "  kb-static       - Static color mode"
        echo "  kb-breathe      - Breathing effect"
        echo "  kb-wave         - Wave effect"
        echo "  kb-zone         - Set per-zone colors"
        echo "  kb-profiles     - List RGB profiles"
        echo "  kb-status       - Show RGB status"
        echo "  kb-help         - Full keyboard help"
        echo ""
        echo "Examples:"
        echo "  $0 turbo              # Set to turbo mode"
        echo "  $0 fan-max            # Set fans to 100%"
        echo "  $0 fan-custom 50 70   # Set CPU fan to 50%, GPU to 70%"
        echo "  $0 battery-enable     # Limit charging to 80%"
        echo "  $0 kb-static #ff0000  # Set keyboard to red"
        echo "  $0 kb-profile-gaming  # Apply gaming RGB profile"
        exit 1
        ;;
esac