#!/bin/bash
#
# Predator Profile Control Script
# Controls GPU power limit via Predator Sense power profiles
#
# Usage: predator-profile {quiet|balanced|performance|turbo|status}
#
# Profiles:
#   quiet       - 60W GPU power limit (power saving)
#   balanced    - 80W GPU power limit (balanced performance)
#   performance - 100W GPU power limit (high performance)
#   turbo       - 125W GPU power limit (maximum performance)
#   status      - Show current profile

SYSFS_PATH="/sys/devices/platform/acer-wmi/predator_sense/power_profile"

# Check if sysfs interface exists
if [ ! -f "$SYSFS_PATH" ]; then
    echo "Error: Predator Sense power profile interface not found!"
    echo "Make sure the linuwu_sense module is loaded."
    exit 1
fi

case "$1" in
    quiet)
        echo 0 | sudo tee $SYSFS_PATH > /dev/null
        if [ $? -eq 0 ]; then
            echo "Power profile set to QUIET (60W GPU limit)"
        else
            echo "Failed to set power profile"
            exit 1
        fi
        ;;
    balanced)
        echo 1 | sudo tee $SYSFS_PATH > /dev/null
        if [ $? -eq 0 ]; then
            echo "Power profile set to BALANCED (80W GPU limit)"
        else
            echo "Failed to set power profile"
            exit 1
        fi
        ;;
    performance)
        echo 2 | sudo tee $SYSFS_PATH > /dev/null
        if [ $? -eq 0 ]; then
            echo "Power profile set to PERFORMANCE (100W GPU limit)"
        else
            echo "Failed to set power profile"
            exit 1
        fi
        ;;
    turbo)
        echo 3 | sudo tee $SYSFS_PATH > /dev/null
        if [ $? -eq 0 ]; then
            echo "Power profile set to TURBO (125W GPU limit)"
        else
            echo "Failed to set power profile"
            exit 1
        fi
        ;;
    status)
        CURRENT=$(cat $SYSFS_PATH)
        case $CURRENT in
            0) echo "Current profile: QUIET (60W GPU limit)" ;;
            1) echo "Current profile: BALANCED (80W GPU limit)" ;;
            2) echo "Current profile: PERFORMANCE (100W GPU limit)" ;;
            3) echo "Current profile: TURBO (125W GPU limit)" ;;
            *) echo "Current profile: UNKNOWN ($CURRENT)" ;;
        esac
        
        # Try to show GPU power limit from nvidia-smi
        if command -v nvidia-smi &> /dev/null; then
            echo ""
            echo "NVIDIA GPU Power Status:"
            nvidia-smi -q -d POWER | grep -E "Power Limit|Power Draw" | head -4
        fi
        ;;
    *)
        echo "Usage: $0 {quiet|balanced|performance|turbo|status}"
        echo ""
        echo "Profiles:"
        echo "  quiet       - 60W GPU power limit (power saving)"
        echo "  balanced    - 80W GPU power limit (balanced performance)"
        echo "  performance - 100W GPU power limit (high performance)"
        echo "  turbo       - 125W GPU power limit (maximum performance)"
        echo "  status      - Show current profile and GPU power info"
        exit 1
        ;;
esac